{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- Back Button -->
        <a href="/projects" class="btn btn-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Вернуться к проектам
        </a>

        <!-- Project Header -->
        <div id="projectHeader"></div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mt-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="versions-tab" data-bs-toggle="tab" data-bs-target="#versions" type="button">
                    Версии
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="updates-tab" data-bs-toggle="tab" data-bs-target="#updates" type="button">
                    Обновления
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Versions Tab -->
            <div class="tab-pane fade show active" id="versions" role="tabpanel">
                <div class="card mt-3">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Версия</th>
                                    <th>Дата выпуска</th>
                                    <th>Тип</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody id="versionsTable">
                                <tr>
                                    <td colspan="4" class="text-center py-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Загрузка...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Updates Tab -->
            <div class="tab-pane fade" id="updates" role="tabpanel">
                <div class="card mt-3">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Дата</th>
                                    <th>От версии</th>
                                    <th>К версии</th>
                                    <th>Тип обновления</th>
                                </tr>
                            </thead>
                            <tbody id="updatesTable">
                                <tr>
                                    <td colspan="4" class="text-center py-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Загрузка...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const projectId = {{ project_id }};

function loadProjectDetails() {
    fetch(`/api/projects/${projectId}`)
        .then(response => response.json())
        .then(project => {
            const headerDiv = document.getElementById('projectHeader');
            headerDiv.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h2>${project.name}</h2>
                                <p class="text-muted">${project.description || 'Нет описания'}</p>
                                <p><small>Категория: <strong>${project.category || 'Не указана'}</strong></small></p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="mb-2">
                                    <small>Текущая версия:</small><br>
                                    <code class="fs-5">${project.current_version || 'Не указана'}</code>
                                </div>
                                <div>
                                    <small>Последняя версия:</small><br>
                                    <code class="fs-5 text-success">${project.latest_version || 'Неизвестна'}</code>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Создан: ${new Date(project.created_at).toLocaleDateString('ru-RU')}</small><br>
                                <small class="text-muted">Последняя проверка: ${project.last_checked ? new Date(project.last_checked).toLocaleString('ru-RU') : 'Никогда'}</small>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-primary btn-sm" onclick="checkUpdate()">
                                    <i class="fas fa-sync"></i> Проверить обновление
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="editProject()">
                                    <i class="fas fa-edit"></i> Изменить
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
}

function loadVersions() {
    fetch(`/api/projects/${projectId}/versions`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('versionsTable');
            tbody.innerHTML = '';
            
            if (data.versions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Нет версий</td></tr>';
                return;
            }

            data.versions.forEach(version => {
                const row = `
                    <tr>
                        <td><code>${version.version_number}</code></td>
                        <td>${version.release_date ? new Date(version.release_date).toLocaleDateString('ru-RU') : '-'}</td>
                        <td>
                            <span class="badge ${version.is_prerelease ? 'bg-warning' : 'bg-secondary'}">
                                ${version.is_prerelease ? 'Pre-release' : 'Release'}
                            </span>
                        </td>
                        <td>
                            ${version.is_latest ? '<span class="badge bg-success">Последняя</span>' : ''}
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        });
}

function loadUpdates() {
    fetch(`/api/projects/${projectId}/updates`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('updatesTable');
            tbody.innerHTML = '';
            
            if (data.updates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Нет обновлений</td></tr>';
                return;
            }

            data.updates.forEach(update => {
                const row = `
                    <tr>
                        <td>${new Date(update.detected_at).toLocaleString('ru-RU')}</td>
                        <td><code>${update.old_version || '-'}</code></td>
                        <td><code class="text-success">${update.new_version}</code></td>
                        <td>
                            <span class="badge bg-info">${update.update_type}</span>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        });
}

function checkUpdate() {
    fetch(`/api/projects/${projectId}/check-update`, {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            loadProjectDetails();
            loadVersions();
            loadUpdates();
        })
        .catch(error => alert('Ошибка: ' + error));
}

document.addEventListener('DOMContentLoaded', function() {
    loadProjectDetails();
    loadVersions();
    loadUpdates();
});
</script>
{% endblock %}
